<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>割り勘精算ツール</title>
  <style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f5f7fa;
  margin: 0;
  padding: 12px;
}

.container {
  max-width: 100%;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  border-radius: 14px;
  overflow: hidden;
}

th, td {
  padding: 10px 6px;
  text-align: center;
  font-size: 14px;
}

th {
  background: #f0f0f0;
  font-weight: 600;
}

input[type="text"],
input[type="number"] {
  width: 100%;
  padding: 8px 6px;
  font-size: 16px; /* iOSで潰れない */
  border-radius: 8px;
  border: 1px solid #ccc;
}

input[readonly] {
  background: #eee;
}

button {
  padding: 10px 14px;
  border: none;
  border-radius: 10px;
  background: #000;
  color: #fff;
  font-size: 15px;
}

.result {
  white-space: pre-wrap;
  background: #fff;
  padding: 14px;
  border-radius: 14px;
  margin-top: 14px;
  font-size: 15px;
}

@media (max-width: 480px) {
  th, td {
    font-size: 12px;
  }
}
</style>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4facfe">
</head>
<body>

<h2>割り勘精算ツール</h2>

<div class="card">

<table id="members">
  <tr>
    <th>名前</th>
    <th>支払①</th>
    <th>支払②</th>
    <th>支払③</th>
    <th>支払④</th>
    <th>支払⑤</th>
    <th>支払合算</th>
    <th></th>
  </tr>
</table>

<button onclick="addRow()">＋ 行を追加</button>

<button onclick="calculate()">計算する</button>

</div>



<div class="result" id="result"></div>
<button onclick="copyResult()">結果をコピー</button>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

const membersTable = document.getElementById('members');
const resultEl = document.getElementById('result');

function copyResult() {
  const text = resultEl.innerText;
  if (!text) {
    alert('コピーする結果がありません');
    return;
  }
  navigator.clipboard.writeText(text).then(() => alert('結果をコピーしました'));
}

function createRow() {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" placeholder="名前"></td>
    <td><input type="number" value="0"></td>
    <td><input type="number" value="0"></td>
    <td><input type="number" value="0"></td>
    <td><input type="number" value="0"></td>
    <td><input type="number" value="0"></td>
    <td><input type="number" value="0" readonly></td>
    <td><button type="button">×</button></td>
  `;

  // 合算
  const nums = tr.querySelectorAll('input[type="number"]');
  nums.forEach((n, i) => {
    if (i < 5) n.addEventListener('input', () => updateRowSum(tr));
  });

  // 削除ボタン
  tr.querySelector('button').addEventListener('click', () => tr.remove());

  

  tr.addEventListener('touchend', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
    const endX = e.changedTouches[0].screenX;
    if (startX - endX > 80) tr.remove();
  }, { passive: true });

  return tr;
}

function addRow() {
  membersTable.appendChild(createRow());
}

function updateRowSum(tr) {
  const nums = tr.querySelectorAll('input[type="number"]');
  let sum = 0;
  for (let i = 0; i < 5; i++) sum += Number(nums[i].value) || 0;
  nums[5].value = sum;
}

function calculate() {
  const rows = membersTable.querySelectorAll('tr');
  const members = [];

  rows.forEach((tr, idx) => {
    if (idx === 0) return; // ヘッダ
    const name = tr.querySelector('input[type="text"]').value.trim();
    const sum = Number(tr.querySelectorAll('input[type="number"]')[5].value) || 0;
    if (name) members.push({ name, sum });
  });

  if (!members.length) {
    resultEl.innerText = '名前が入力されていません';
    return;
  }

  const total = members.reduce((a, b) => a + b.sum, 0);
  const avg = Math.round(total / members.length);

  const payers = [];
  const receivers = [];

  members.forEach(m => {
    const diff = m.sum - avg;
    if (diff > 0) receivers.push({ ...m, diff });
    if (diff < 0) payers.push({ ...m, diff: -diff });
  });

  const fmt = n => Math.round(n).toLocaleString();

  let text = `【割り勘精算】
合計：${fmt(total)}円
1人あたり：${fmt(avg)}円

`;;

  payers.forEach(p => receivers.forEach(r => {
    if (p.diff > 0 && r.diff > 0) {
      const amt = Math.min(p.diff, r.diff);
      text += `${p.name} → ${r.name} に ${fmt(amt)}円
`;
      p.diff -= amt;
      r.diff -= amt;
    }
  }));

  resultEl.innerText = text || '精算不要です';
}

// 初期行
document.addEventListener('DOMContentLoaded', () => addRow());
</script>
