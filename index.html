<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>割り勘精算ツール</title>
  <style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f5f7fa;
  margin: 0;
  padding: 12px;
}

.container {
  max-width: 100%;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  border-radius: 14px;
  overflow: hidden;
}

th, td {
  padding: 10px 6px;
  text-align: center;
  font-size: 14px;
}

th {
  background: #f0f0f0;
  font-weight: 600;
}

input[type="text"],
input[type="number"] {
  width: 100%;
  padding: 8px 6px;
  font-size: 16px; /* iOSで潰れない */
  border-radius: 8px;
  border: 1px solid #ccc;
}

input[readonly] {
  background: #eee;
}

button {
  padding: 10px 14px;
  border: none;
  border-radius: 10px;
  background: #000;
  color: #fff;
  font-size: 15px;
}

.result {
  white-space: pre-wrap;
  background: #fff;
  padding: 14px;
  border-radius: 14px;
  margin-top: 14px;
  font-size: 15px;
}

@media (max-width: 480px) {
  th, td {
    font-size: 12px;
  }
}
</style>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4facfe">
</head>
<body>

<h2>割り勘精算ツール</h2>

<div class="card">

<table id="members">
  <tr>
    <th>名前</th>
    <th>支払①</th>
    <th>支払②</th>
    <th>支払③</th>
    <th>支払④</th>
    <th>支払⑤</th>
    <th>支払合算</th>
    <th></th>
  </tr>
</table>

<button onclick="addRow()">＋ 行を追加</button>

<button onclick="calculate()">計算する</button>

</div>



<div class="result" id="result"></div>
<button onclick="copyResult()">結果をコピー</button>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

function copyResult() {
  const text = document.getElementById('result').innerText;
  if (!text) {
    alert('コピーする結果がありません');
    return;
  }
  navigator.clipboard.writeText(text).then(() => {
    alert('結果をコピーしました');
  });
}

function createRow(name = '') {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" value="${name}" oninput="toggleRow(this)"></td>
    <td><input type="number" value="0" oninput="updateSum(this)"></td>
    <td><input type="number" value="0" oninput="updateSum(this)"></td>
    <td><input type="number" value="0" oninput="updateSum(this)"></td>
    <td><input type="number" value="0" oninput="updateSum(this)"></td>
    <td><input type="number" value="0" oninput="updateSum(this)"></td>
    <td><input type="number" value="0" readonly></td>
    <td><button onclick="removeRow(this)">×</button></td>
  `;
  return tr;
}

function addRow() {
  document.getElementById('members').appendChild(createRow());
}

function removeRow(btn) {
  btn.closest('tr').remove();
}

function toggleRow(input) {
  // 名前が空でも行は残す（削除しない）
}

function updateSum(input) {
  const row = input.closest('tr');
  const nums = row.querySelectorAll('input[type="number"]');
  let sum = 0;
  for (let i = 0; i < nums.length - 1; i++) {
    sum += Number(nums[i].value) || 0;
  }
  nums[nums.length - 1].value = sum;
}

function calculate() {
  const rows = document.querySelectorAll('#members tr');
  const members = [];

  for (let i = 1; i < rows.length; i++) {
    if (rows[i].style.display === 'none') continue;
    const inputs = rows[i].querySelectorAll('input');
    const name = inputs[0].value.trim();
    if (!name) continue;
    const paid = Number(inputs[inputs.length - 2].value) || 0;
    members.push({ name, paid });
  }

  const total = members.reduce((s, m) => s + m.paid, 0);
  const share = members.length ? total / members.length : 0;

  const receivers = [];
  const payers = [];

  members.forEach(m => {
    const diff = m.paid - share;
    if (diff > 0) receivers.push({ name: m.name, amount: diff });
    if (diff < 0) payers.push({ name: m.name, amount: -diff });
  });

  let text = `【割り勘精算】
合計：${total}円
1人あたり：${Math.round(share)}円

`;

  payers.forEach(p => {
    receivers.forEach(r => {
      if (p.amount > 0 && r.amount > 0) {
        const pay = Math.min(p.amount, r.amount);
        p.amount -= pay;
        r.amount -= pay;
        text += `${p.name} → ${r.name} に ${Math.round(pay)}円
`;
      }
    });
  });

  document.getElementById('result').innerText = text || '精算不要です';
}

// ===== 初期表示 =====
// 名前なしの1行だけ表示
addRow();

// ===== スワイプで行削除（スマホ向け） =====
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', e => {
  touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe(e.target);
});

function handleSwipe(target) {
  if (touchStartX - touchEndX > 80) {
    const row = target.closest('tr');
    if (row && row.parentElement.id === 'members') {
      row.remove();
    }
  }
}
